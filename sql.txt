CREATE TABLE Users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255),
    username VARCHAR(100) NOT NULL,
    avatar_url TEXT,
    role VARCHAR(50) DEFAULT 'user' CHECK (role IN ('user', 'admin')),
    is_active BOOLEAN DEFAULT TRUE,
    social_id VARCHAR(255),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
CREATE TABLE Categories (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) UNIQUE NOT NULL,
    type VARCHAR(50) NOT NULL CHECK (type IN ('food_type', 'venue_type', 'feature')),
    icon_url TEXT
);
CREATE TABLE Locations (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    address TEXT NOT NULL,
    district VARCHAR(100) NOT NULL,
    latitude NUMERIC(10, 8) NOT NULL,
    longitude NUMERIC(11, 8) NOT NULL,
    phone_number VARCHAR(20),
    opening_hours JSONB,
    min_price INTEGER,
    max_price INTEGER,
    google_maps_link TEXT,
    is_approved BOOLEAN DEFAULT FALSE,
    average_rating NUMERIC(3, 2) DEFAULT 0.0,
    review_count INTEGER DEFAULT 0,
    created_by_user_id INTEGER REFERENCES Users(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
CREATE TABLE LocationCategories (
    location_id INTEGER REFERENCES Locations(id) ON DELETE CASCADE,
    category_id INTEGER REFERENCES Categories(id) ON DELETE CASCADE,
    PRIMARY KEY (location_id, category_id)
);
CREATE TABLE LocationImages (
    id SERIAL PRIMARY KEY,
    location_id INTEGER REFERENCES Locations(id) ON DELETE CASCADE NOT NULL,
    image_url TEXT NOT NULL,
    is_main BOOLEAN DEFAULT FALSE
);
CREATE TABLE Dishes (
    id SERIAL PRIMARY KEY,
    location_id INTEGER REFERENCES Locations(id) ON DELETE CASCADE NOT NULL,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    price INTEGER,
    image_url TEXT,
    category_id INTEGER REFERENCES Categories(id),
    average_rating NUMERIC(3, 2) DEFAULT 0.0,
    review_count INTEGER DEFAULT 0,
    UNIQUE (location_id, name)
);
CREATE TABLE Reviews (
    id SERIAL PRIMARY KEY,
    location_id INTEGER REFERENCES Locations(id) ON DELETE CASCADE NOT NULL,
    dish_id INTEGER REFERENCES Dishes(id) ON DELETE CASCADE,
    user_id INTEGER REFERENCES Users(id) ON DELETE CASCADE NOT NULL,
    rating INTEGER NOT NULL CHECK (rating BETWEEN 1 AND 5),
    comment TEXT,
    review_type VARCHAR(50) NOT NULL CHECK (review_type IN ('location', 'dish')),
    is_approved BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
CREATE TABLE Favorites (
    user_id INTEGER REFERENCES Users(id) ON DELETE CASCADE,
    location_id INTEGER REFERENCES Locations(id) ON DELETE CASCADE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (user_id, location_id)
);
CREATE TABLE LocationProposals (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    address TEXT NOT NULL,
    district VARCHAR(100),  
    latitude NUMERIC(10, 8),  
    longitude NUMERIC(11, 8),   
    phone_number VARCHAR(20),  
    proposed_by_user_id INTEGER REFERENCES Users(id),
    status VARCHAR(50) DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected')),
    rejection_reason TEXT,  
    reviewed_by_admin_id INTEGER REFERENCES Users(id),  
    reviewed_at TIMESTAMP WITH TIME ZONE,   
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
CREATE TABLE UserActivityLog (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES Users(id) ON DELETE CASCADE,
    location_id INTEGER REFERENCES Locations(id) ON DELETE CASCADE,
    activity_type VARCHAR(50) CHECK (activity_type IN ('view', 'search', 'favorite')),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
CREATE TABLE Notifications (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES Users(id) ON DELETE CASCADE NOT NULL,
    title VARCHAR(255) NOT NULL,
    message TEXT,
    type VARCHAR(50) CHECK (type IN ('proposal_approved', 'proposal_rejected', 'review_reply', 'system')) NOT NULL,
    related_id INTEGER,  -- ID của proposal/review liên quan
    is_read BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_notifications_user_unread ON Notifications(user_id, is_read);
